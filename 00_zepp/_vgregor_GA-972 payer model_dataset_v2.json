{"paragraphs":[{"text":"import org.joda.time.LocalDate\nimport org.apache.spark.sql.DataFrame\nimport com.pixelfederation.dwh.spark.utils._","dateUpdated":"2019-01-21T13:43:15+0100","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"import org.joda.time.LocalDate\nimport org.apache.spark.sql.DataFrame\nimport com.pixelfederation.dwh.spark.utils._\n"}]},"apps":[],"jobName":"paragraph_1548071155159_-1577200234","id":"20181212-170149_541435616","dateCreated":"2019-01-21T12:45:55+0100","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1611","user":"vgregor","dateFinished":"2019-01-21T13:43:16+0100","dateStarted":"2019-01-21T13:43:15+0100"},{"text":"val project = \"DA\"\n\nval maxDigX = 3\nval maxDigY = 84\nval regDateFrom = LocalDate.parse(\"2018-05-01\")\nval regDateTo = LocalDate.parse(\"2018-09-30\")\nval eventDateTo = regDateTo.plusDays(maxDigX + 1)\nval payDateTo = regDateTo.plusDays(maxDigY + 1)\n\nval dims = Seq(\"player_id\", \"register_platform\", \"register_date\", \"register_month\", \"source\", \"country\", \"tier\", \"is_us\")\nval hiveSchema = \"vgregor\"\nval hiveTable = \"ga_972_payer_dataset_v2\"\n\ndef nullToZero(colName: String)(df: DataFrame): DataFrame =\n    df.withColumn(colName, when(col(colName).isNull, lit(0)).otherwise(col(colName)))\n\n// dx - interval of days [0, maxDigX]\n// dy - interval of days (maxDigX, maxDigY]","dateUpdated":"2019-01-21T13:43:17+0100","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"project: String = DA\nmaxDigX: Int = 3\nmaxDigY: Int = 84\nregDateFrom: org.joda.time.LocalDate = 2018-05-01\nregDateTo: org.joda.time.LocalDate = 2018-09-30\neventDateTo: org.joda.time.LocalDate = 2018-10-04\npayDateTo: org.joda.time.LocalDate = 2018-12-24\ndims: Seq[String] = List(player_id, register_platform, register_date, register_month, source, country, tier, is_us)\nhiveSchema: String = vgregor\nhiveTable: String = ga_972_payer_dataset_v2\nnullToZero: (colName: String)(df: org.apache.spark.sql.DataFrame)org.apache.spark.sql.DataFrame\n"}]},"apps":[],"jobName":"paragraph_1548071155228_-1900774059","id":"20181212-170248_928910633","dateCreated":"2019-01-21T12:45:55+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1612","user":"vgregor","dateFinished":"2019-01-21T13:43:18+0100","dateStarted":"2019-01-21T13:43:17+0100"},{"text":"val tier = sqlContext.table(\"dwh.country_tiers\")\n    .filter($\"project\" === project)\n    .filter($\"quarter\" === getQuarterFromMonth(payDateTo.getMonthOfYear()))\n    .filter($\"year\" === payDateTo.getYear())\n    .select(\n        $\"country_code\".as(\"country\"),\n        $\"tier\"\n    )\n\nval attr = getLastValidAttribution(project, payDateTo)(sqlContext, sc)\n    .select(\n        $\"player_id\",\n        $\"source\"\n    )\n\nval prof = getProfiles(project)(sqlContext)\n    .join(\n        getUserType(project)(sqlContext)\n            .select($\"player_id\", $\"user_type\")\n            .filter($\"user_type\" !== \"user\"),\n        Seq(\"player_id\"),\n        \"left\"\n    )\n    .filter($\"user_type\".isNull)\n    .drop(\"user_type\")\n    .withColumn(\"register_date\", to_date($\"register_time\"))\n    .withColumn(\"register_month\", trunc($\"register_date\", \"MM\"))\n    .filter($\"register_date\" >= regDateFrom.toString)\n    .filter($\"register_date\" <= regDateTo.toString)\n    .withColumn(\"is_us\", $\"country\" === \"US\")\n    .join(attr, Seq(\"player_id\"), \"left\")\n    .join(tier, Seq(\"country\"), \"left\")\n    .withColumn(\"tier\", when($\"tier\".isNull, lit(\"4\")).otherwise($\"tier\"))\n    .select(dims ++ Seq(\"register_time\") map col:_*)\n\nval pay = sqlContext.table(project.toLowerCase ++ \"_bckp.monetization\")\n    .select(\n        $\"player_id\",\n        $\"create_time\",\n        $\"order_item_id\",\n        $\"eur_netto\"\n    )\n    .join(prof, Seq(\"player_id\"), \"left\")\n    .filter($\"register_date\".isNotNull)\n    .withColumn(\"days_in_game\", getDaysBetween.udf($\"register_time\", $\"create_time\"))\n    .filter($\"days_in_game\" <= maxDigY)\n    .select(\n        dims ++ \n        Seq(\n            \"create_time\",\n            \"days_in_game\",\n            \"order_item_id\",\n            \"eur_netto\"\n        ) map col:_*\n    )\n\nval payGrp = pay.groupBy(\"player_id\")\n    .agg(\n        count(when($\"days_in_game\" <= maxDigX, $\"player_id\").otherwise(lit(null))).as(\"dx_pay_count\"),\n        count(when($\"days_in_game\" > maxDigX, $\"player_id\").otherwise(lit(null))).as(\"dy_pay_count\")\n    )\n    .withColumn(\"dx_payer\", $\"dx_pay_count\" > 0)\n    .withColumn(\"dy_payer\", $\"dy_pay_count\" > 0)\n\nval sessionThreshold = 30\nval session = sqlContext.table(s\"$project.sessions_threshold\")\n    .filter($\"partition_date\" >= regDateFrom.toString)                  // POZOR NA FILTER PARTITION_DATE (HLAVNE NA NOVOM CLUSTRI)\n    .filter($\"partition_date\" <= eventDateTo.toString)\n    .filter($\"inactivity_threshold\" === sessionThreshold)\n    .join(prof, Seq(\"player_id\"), \"left\")\n    .filter($\"register_date\".isNotNull)\n    .withColumn(\"days_in_game\", getDaysBetween.udf($\"register_time\", $\"session_start\"))\n    .filter($\"days_in_game\" <= maxDigX)\n    .groupBy(\"player_id\")\n    .agg(\n        countDistinct($\"date\").as(\"dx_active_days\"),\n        count(when($\"days_in_game\" <= 0, $\"player_id\").otherwise(lit(null))).as(\"d0_session_count\"),\n        count(when($\"days_in_game\" > 0, $\"player_id\").otherwise(lit(null))).as(\"d1x_session_count\")\n    )\n    .withColumn(\"d1x_daily_session_count_relative_to_d0\", $\"d1x_session_count\"/($\"dx_active_days\" - 1)/$\"d0_session_count\")\n\nval profJoin = prof.select(dims map col:_*)\n    .join(payGrp, Seq(\"player_id\"), \"left\")\n    .transform(nullToZero(\"dx_pay_count\"))\n    .transform(nullToZero(\"dy_pay_count\"))\n    .withColumn(\"dx_payer\", when($\"dx_payer\".isNull, lit(false)).otherwise($\"dx_payer\"))\n    .withColumn(\"dy_payer\", when($\"dy_payer\".isNull, lit(false)).otherwise($\"dy_payer\"))\n    .join(session, Seq(\"player_id\"), \"left\")\n    .transform(nullToZero(\"dx_active_days\"))\n    .transform(nullToZero(\"d0_session_count\"))\n    .transform(nullToZero(\"d1x_session_count\"))\n    .transform(nullToZero(\"d1x_daily_session_count_relative_to_d0\"))","dateUpdated":"2019-01-21T13:43:20+0100","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"tier: org.apache.spark.sql.DataFrame = [country: string, tier: string]\nattr: org.apache.spark.sql.DataFrame = [player_id: string, source: string]\nprof: org.apache.spark.sql.DataFrame = [player_id: string, register_platform: string, register_date: date, register_month: date, source: string, country: string, tier: string, is_us: boolean, register_time: timestamp]\npay: org.apache.spark.sql.DataFrame = [player_id: string, register_platform: string, register_date: date, register_month: date, source: string, country: string, tier: string, is_us: boolean, create_time: timestamp, days_in_game: int, order_item_id: string, eur_netto: double]\npayGrp: org.apache.spark.sql.DataFrame = [player_id: string, dx_pay_count: bigint, dy_pay_count: bigint, dx_payer: boolean, dy_payer: boolean]\nsessionThreshold: Int = 30\nsession: org.apache.spark.sql.DataFrame = [player_id: string, dx_active_days: bigint, d0_session_count: bigint, d1x_session_count: bigint, d1x_daily_session_count_relative_to_d0: double]\nprofJoin: org.apache.spark.sql.DataFrame = [player_id: string, register_platform: string, register_date: date, register_month: date, source: string, country: string, tier: string, is_us: boolean, dx_pay_count: bigint, dy_pay_count: bigint, dx_payer: boolean, dy_payer: boolean, dx_active_days: bigint, d0_session_count: bigint, d1x_session_count: bigint, d1x_daily_session_count_relative_to_d0: double]\n"}]},"apps":[],"jobName":"paragraph_1548071155253_-1910392782","id":"20181212-170252_411766982","dateCreated":"2019-01-21T12:45:55+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1613","user":"vgregor","dateFinished":"2019-01-21T13:43:22+0100","dateStarted":"2019-01-21T13:43:20+0100"},{"text":"profJoin.write\n    .format(\"orc\")\n    .mode(\"overwrite\")\n    .saveAsTable(s\"$hiveSchema.$hiveTable\")","dateUpdated":"2019-01-21T13:43:30+0100","config":{"colWidth":11,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1548071155275_-1929630227","id":"20181213-160835_751060643","dateCreated":"2019-01-21T12:45:55+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1614","user":"vgregor","dateFinished":"2019-01-21T13:51:50+0100","dateStarted":"2019-01-21T13:43:30+0100"},{"text":"val x = sqlContext.table(s\"$hiveSchema.$hiveTable\")","dateUpdated":"2019-01-21T13:43:32+0100","config":{"colWidth":10,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"x: org.apache.spark.sql.DataFrame = [player_id: string, register_platform: string, register_date: date, register_month: date, source: string, country: string, tier: string, is_us: boolean, dx_pay_count: bigint, dy_pay_count: bigint, dx_payer: boolean, dy_payer: boolean, dx_active_days: bigint, d0_session_count: bigint, d1x_session_count: bigint, d1x_daily_session_count_relative_to_d0: double]\n"}]},"apps":[],"jobName":"paragraph_1548071155295_-1925013240","id":"20181213-162025_2135551146","dateCreated":"2019-01-21T12:45:55+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1615","user":"vgregor","dateFinished":"2019-01-21T13:51:50+0100","dateStarted":"2019-01-21T13:43:32+0100"},{"text":"x.count\nx.show(10, true)","dateUpdated":"2019-01-21T13:43:33+0100","config":{"colWidth":10,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"res88: Long = 2645936\n+---------+-----------------+-------------+--------------+---------+-------+----+-----+------------+------------+--------+--------+--------------+----------------+-----------------+--------------------------------------+\n|player_id|register_platform|register_date|register_month|   source|country|tier|is_us|dx_pay_count|dy_pay_count|dx_payer|dy_payer|dx_active_days|d0_session_count|d1x_session_count|d1x_daily_session_count_relative_to_d0|\n+---------+-----------------+-------------+--------------+---------+-------+----+-----+------------+------------+--------+--------+--------------+----------------+-----------------+--------------------------------------+\n|     1497|          unknown|   2018-07-31|    2018-07-01|     null|   null|   4| null|           0|           0|   false|   false|             0|               0|                0|                                   0.0|\n|     1659|          unknown|   2018-07-31|    2018-07-01|     null|   null|   4| null|           0|           0|   false|   false|             0|               0|                0|                                   0.0|\n|     2270|          unknown|   2018-07-31|    2018-07-01|     null|   null|   4| null|           0|           0|   false|   false|             0|               0|                0|                                   0.0|\n| 25753773|      google play|   2018-05-01|    2018-05-01|marketing|     DE|   1|false|           0|           0|   false|   false|             2|               2|                1|                                   0.5|\n| 25753935|   apple appstore|   2018-05-01|    2018-05-01|    viral|     US|   1| true|           0|           0|   false|   false|             1|               3|                0|                                   0.0|\n| 25754051|      google play|   2018-05-01|    2018-05-01|marketing|     US|   1| true|           0|           0|   false|   false|             1|               1|                0|                                   0.0|\n| 25754169|         facebook|   2018-05-01|    2018-05-01|marketing|     US|   1| true|           0|           0|   false|   false|             1|               1|                0|                                   0.0|\n| 25754213|      google play|   2018-05-01|    2018-05-01|    viral|     RO|   3|false|           0|           0|   false|   false|             1|               1|                0|                                   0.0|\n| 25754664|      google play|   2018-05-01|    2018-05-01|marketing|     TH|   3|false|           0|           0|   false|   false|             1|               2|                0|                                   0.0|\n| 25754826|      google play|   2018-05-01|    2018-05-01|marketing|     CO|   4|false|           0|           0|   false|   false|             1|               1|                0|                                   0.0|\n+---------+-----------------+-------------+--------------+---------+-------+----+-----+------------+------------+--------+--------+--------------+----------------+-----------------+--------------------------------------+\nonly showing top 10 rows\n\n"}]},"apps":[],"jobName":"paragraph_1548071155317_-1935016711","id":"20181213-171609_238294854","dateCreated":"2019-01-21T12:45:55+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1616","user":"vgregor","dateFinished":"2019-01-21T13:52:00+0100","dateStarted":"2019-01-21T13:51:50+0100"},{"text":"x.filter($\"player_id\" isin (25795782, 26085365, 25946144, 25946142)).show(10, true)","dateUpdated":"2019-01-21T12:55:07+0100","config":{"colWidth":10,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+---------+-----------------+-------------+---------+-------+----+-----+------------+------------+--------+--------+--------------+----------------+-----------------+--------------------------------------+\n|player_id|register_platform|register_date|   source|country|tier|is_us|dx_pay_count|dy_pay_count|dx_payer|dy_payer|dx_active_days|d0_session_count|d1x_session_count|d1x_daily_session_count_relative_to_d0|\n+---------+-----------------+-------------+---------+-------+----+-----+------------+------------+--------+--------+--------------+----------------+-----------------+--------------------------------------+\n| 25946142|      google play|   2018-05-14|    viral|     FR|   2|false|           0|           0|   false|   false|             1|               1|                0|                                   0.0|\n| 25795782|      google play|   2018-05-03|    viral|     AT|   1|false|           2|           0|    true|   false|             5|               2|                4|                                   0.5|\n| 25946144|   apple appstore|   2018-05-14|marketing|     US|   1| true|           0|           3|   false|    true|             4|               1|                4|                    1.3333333333333333|\n| 26085365|      google play|   2018-05-24|marketing|     AR|   4|false|           1|           6|    true|    true|             5|               2|                9|                                 1.125|\n+---------+-----------------+-------------+---------+-------+----+-----+------------+------------+--------+--------+--------------+----------------+-----------------+--------------------------------------+\n\n"}]},"apps":[],"jobName":"paragraph_1548071155340_-1857682182","id":"20181213-171621_1263441624","dateCreated":"2019-01-21T12:45:55+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1617","user":"vgregor","dateFinished":"2019-01-21T13:05:03+0100","dateStarted":"2019-01-21T13:04:33+0100"},{"text":"// Double-checking the payments - OK\n\nval xxx = sqlContext.read.parquet(\"events/DA/2018-*/payment\")\n    .filter($\"player_id\" isin (25795782, 26085365, 25946144, 25946142))\n    .join(getProfiles(\"DA\")(sqlContext), Seq(\"player_id\"), \"left\")\n    .withColumn(\"create_time\", makeTimestamp.udf($\"event_data/create_time\"))\n    .withColumn(\"days_in_game\", getDaysBetween.udf($\"register_time\", $\"create_time\"))\n    .select($\"player_id\", $\"create_time\", $\"event_data/eur_netto\", $\"days_in_game\")\n\nxxx.orderBy($\"player_id\", $\"create_time\")show(50, false)","dateUpdated":"2019-01-21T13:35:50+0100","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{"0":{"graph":{"mode":"table","height":374,"optionOpen":false}}},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"xxx: org.apache.spark.sql.DataFrame = [player_id: string, create_time: timestamp, event_data/eur_netto: double, days_in_game: int]\n+---------+---------------------+--------------------+------------+\n|player_id|create_time          |event_data/eur_netto|days_in_game|\n+---------+---------------------+--------------------+------------+\n|25795782 |2018-05-06 12:49:06.0|5.824               |2           |\n|25795782 |2018-05-06 12:51:06.0|2.912               |2           |\n|25946144 |2018-05-30 05:14:39.0|2.4143536944107975  |15          |\n|25946144 |2018-06-06 20:19:16.0|2.9877730192719483  |22          |\n|25946144 |2018-06-23 00:47:28.0|12.01147664835165   |39          |\n|26085365 |2018-05-27 19:42:19.0|4.186423982869379   |3           |\n|26085365 |2018-06-25 05:02:13.0|3.50103021978022    |32          |\n|26085365 |2018-06-29 05:01:03.0|3.485568505568506   |36          |\n|26085365 |2018-07-10 03:28:08.0|6.987379760793961   |47          |\n|26085365 |2018-07-16 00:48:33.0|7.013043030146869   |52          |\n|26085365 |2018-07-20 05:40:18.0|3.505857783914394   |57          |\n|26085365 |2018-08-01 03:45:32.0|6.979202453987731   |69          |\n|26085365 |2018-12-26 04:46:00.0|3.4936816269284714  |216         |\n+---------+---------------------+--------------------+------------+\n\n"}]},"apps":[],"jobName":"paragraph_1548071155372_-1869994147","id":"20181213-162944_1641778776","dateCreated":"2019-01-21T12:45:55+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:1618","user":"vgregor","dateFinished":"2019-01-21T13:05:50+0100","dateStarted":"2019-01-21T13:04:45+0100"},{"dateUpdated":"2019-01-21T12:45:55+0100","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1548071155396_-1879228121","id":"20181213-163641_2111618994","dateCreated":"2019-01-21T12:45:55+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:1619"}],"name":"/vgregor/GA-972 payer model/dataset_v2","id":"2E25J3DA7","angularObjects":{"2CWQP86XV:shared_process":[],"2CUVK23ET:shared_process":[],"2CT7YKQWE:shared_process":[],"2CWB61MB6:shared_process":[],"2CV4XJYBM:vgregor:":[],"2CT6NMZMH:shared_process":[],"2CWSFKDCB:shared_process":[],"2CTEKSP32:shared_process":[],"2CV83X352:shared_process":[],"2CWTSWYXU:shared_process":[],"2CVUMHN41:shared_process":[],"2CWZ3Q7YQ:shared_process":[],"2CVFU6JRX:shared_process":[],"2CTGV8686:shared_process":[],"2CUUFFKZP:shared_process":[],"2CTWWDH59:shared_process":[],"2CTSJM5JN:shared_process":[],"2CTPKBVRV:shared_process":[],"2CUZUPS95:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}