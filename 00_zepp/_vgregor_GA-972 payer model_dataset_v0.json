{"paragraphs":[{"text":"import org.joda.time.LocalDate\nimport com.pixelfederation.dwh.spark.utils._","user":"vgregor","dateUpdated":"2018-12-13T17:28:43+0100","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"import org.joda.time.LocalDate\nimport com.pixelfederation.dwh.spark.utils._\n"}]},"apps":[],"jobName":"paragraph_1544630509293_-939727077","id":"20181212-170149_541435616","dateCreated":"2018-12-12T17:01:49+0100","dateStarted":"2018-12-13T17:28:44+0100","dateFinished":"2018-12-13T17:29:32+0100","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:867"},{"text":"val project = \"DA\"\n\nval maxDigX = 3\nval maxDigY = 84\nval regDateFrom = LocalDate.parse(\"2018-03-01\")\nval regDateTo = LocalDate.parse(\"2018-05-31\")\nval payDateTo = regDateTo.plusDays(maxDigY + 1)\n\nval dims = Seq(\"player_id\", \"register_platform\", \"register_date\", \"source\", \"country\", \"tier\", \"is_us\")\nval hiveSchema = \"vgregor\"\nval hiveTable = \"ga_972_payer_dataset_v0\"\n\n// dx - interval of days [0, maxDigX]\n// dy - interval of days (maxDigX, maxDigY]","user":"vgregor","dateUpdated":"2018-12-13T17:28:45+0100","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"project: String = DA\nmaxDigX: Int = 3\nmaxDigY: Int = 84\nregDateFrom: org.joda.time.LocalDate = 2018-03-01\nregDateTo: org.joda.time.LocalDate = 2018-05-31\npayDateTo: org.joda.time.LocalDate = 2018-08-24\ndims: Seq[String] = List(player_id, register_platform, register_date, source, country, tier, is_us)\nhiveSchema: String = vgregor\nhiveTable: String = ga_972_payer_dataset_v0\n"}]},"apps":[],"jobName":"paragraph_1544630568851_727648774","id":"20181212-170248_928910633","dateCreated":"2018-12-12T17:02:48+0100","dateStarted":"2018-12-13T17:28:47+0100","dateFinished":"2018-12-13T17:29:34+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:868"},{"text":"val tier = sqlContext.table(\"dwh.country_tiers\")\n    .filter($\"project\" === project)\n    .filter($\"quarter\" === getQuarterFromMonth(payDateTo.getMonthOfYear()))\n    .filter($\"year\" === payDateTo.getYear())\n    .select(\n        $\"country_code\".as(\"country\"),\n        $\"tier\"\n    )\n\nval attr = getLastValidAttribution(project, payDateTo)(sqlContext, sc)\n    .select(\n        $\"player_id\",\n        $\"source\"\n    )\n\nval prof = getProfiles(project)(sqlContext)\n    .join(\n        getUserType(project)(sqlContext)\n            .select($\"player_id\", $\"user_type\")\n            .filter($\"user_type\" !== \"user\"),\n        Seq(\"player_id\"),\n        \"left\"\n    )\n    .filter($\"user_type\".isNull)\n    .drop(\"user_type\")\n    .withColumn(\"register_date\", to_date($\"register_time\"))\n    .filter($\"register_date\" >= regDateFrom.toString)\n    .filter($\"register_date\" <= regDateTo.toString)\n    .withColumn(\"is_us\", $\"country\" === \"US\")\n    .join(attr, Seq(\"player_id\"), \"left\")\n    .join(tier, Seq(\"country\"), \"left\")\n    .withColumn(\"tier\", when($\"tier\".isNull, lit(\"4\")).otherwise($\"tier\"))\n    .select(dims ++ Seq(\"register_time\") map col:_*)\n\nval pay = sqlContext.table(project.toLowerCase ++ \"_bckp.monetization\")\n    .select(\n        $\"player_id\",\n        $\"create_time\",\n        $\"order_item_id\",\n        $\"eur_netto\"\n    )\n    .join(prof, Seq(\"player_id\"), \"left\")\n    .filter($\"register_date\".isNotNull)\n    .withColumn(\"days_in_game\", getDaysBetween.udf($\"register_time\", $\"create_time\"))\n    .filter($\"days_in_game\" <= maxDigY)\n    .select(\n        dims ++ \n        Seq(\n            \"create_time\",\n            \"days_in_game\",\n            \"order_item_id\",\n            \"eur_netto\"\n        ) map col:_*\n    )\n\nval payGrp = pay.groupBy(\"player_id\")\n    .agg(\n        count(when($\"days_in_game\" <= maxDigX, $\"player_id\").otherwise(lit(null))).as(\"dx_pay_count\"),\n        count(when($\"days_in_game\" > maxDigX, $\"player_id\").otherwise(lit(null))).as(\"dy_pay_count\")\n    )\n    .withColumn(\"dx_payer\", $\"dx_pay_count\" > 0)\n    .withColumn(\"dy_payer\", $\"dy_pay_count\" > 0)\n\nval profJoin = prof.select(dims map col:_*)\n    .join(payGrp, Seq(\"player_id\"), \"left\")\n    .withColumn(\"dx_pay_count\", when($\"dx_pay_count\".isNull, lit(0)).otherwise($\"dx_pay_count\"))\n    .withColumn(\"dy_pay_count\", when($\"dy_pay_count\".isNull, lit(0)).otherwise($\"dy_pay_count\"))\n    .withColumn(\"dx_payer\", when($\"dx_payer\".isNull, lit(false)).otherwise($\"dx_payer\"))\n    .withColumn(\"dy_payer\", when($\"dy_payer\".isNull, lit(false)).otherwise($\"dy_payer\"))","user":"vgregor","dateUpdated":"2018-12-13T17:28:48+0100","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"tier: org.apache.spark.sql.DataFrame = [country: string, tier: string]\nattr: org.apache.spark.sql.DataFrame = [player_id: string, source: string]\nprof: org.apache.spark.sql.DataFrame = [player_id: string, register_platform: string, register_date: date, source: string, country: string, tier: string, is_us: boolean, register_time: timestamp]\npay: org.apache.spark.sql.DataFrame = [player_id: string, register_platform: string, register_date: date, source: string, country: string, tier: string, is_us: boolean, create_time: timestamp, days_in_game: int, order_item_id: string, eur_netto: double]\npayGrp: org.apache.spark.sql.DataFrame = [player_id: string, dx_pay_count: bigint, dy_pay_count: bigint, dx_payer: boolean, dy_payer: boolean]\nprofJoin: org.apache.spark.sql.DataFrame = [player_id: string, register_platform: string, register_date: date, source: string, country: string, tier: string, is_us: boolean, dx_pay_count: bigint, dy_pay_count: bigint, dx_payer: boolean, dy_payer: boolean]\n"}]},"apps":[],"jobName":"paragraph_1544630572363_-1877501353","id":"20181212-170252_411766982","dateCreated":"2018-12-12T17:02:52+0100","dateStarted":"2018-12-13T17:29:33+0100","dateFinished":"2018-12-13T17:29:38+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:869"},{"text":"profJoin.write\n    .format(\"orc\")\n    .mode(\"overwrite\")\n    .saveAsTable(s\"$hiveSchema.$hiveTable\")","user":"vgregor","dateUpdated":"2018-12-13T17:29:53+0100","config":{"colWidth":11,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1544713715436_-627111739","id":"20181213-160835_751060643","dateCreated":"2018-12-13T16:08:35+0100","dateStarted":"2018-12-13T17:29:53+0100","dateFinished":"2018-12-13T17:32:47+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:870"},{"text":"val x = sqlContext.table(s\"$hiveSchema.$hiveTable\")","user":"vgregor","dateUpdated":"2018-12-13T17:36:58+0100","config":{"colWidth":10,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"x: org.apache.spark.sql.DataFrame = [player_id: string, register_platform: string, register_date: date, source: string, country: string, tier: string, is_us: boolean, dx_pay_count: bigint, dy_pay_count: bigint, dx_payer: boolean, dy_payer: boolean]\n"}]},"apps":[],"jobName":"paragraph_1544714425111_1283029156","id":"20181213-162025_2135551146","dateCreated":"2018-12-13T16:20:25+0100","dateStarted":"2018-12-13T17:36:58+0100","dateFinished":"2018-12-13T17:36:59+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:871"},{"text":"x.count\nx.show(10, true)","user":"vgregor","dateUpdated":"2018-12-13T17:37:00+0100","config":{"colWidth":10,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544717769250_723950133","id":"20181213-171609_238294854","dateCreated":"2018-12-13T17:16:09+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:872","dateFinished":"2018-12-13T17:37:06+0100","dateStarted":"2018-12-13T17:37:00+0100","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"res12: Long = 1903994\n+---------+-----------------+-------------+---------+-------+----+-----+------------+------------+--------+--------+\n|player_id|register_platform|register_date|   source|country|tier|is_us|dx_pay_count|dy_pay_count|dx_payer|dy_payer|\n+---------+-----------------+-------------+---------+-------+----+-----+------------+------------+--------+--------+\n| 24290480|   apple appstore|   2018-03-01|marketing|     CA|   1|false|           0|           0|   false|   false|\n| 24290598|      google play|   2018-03-01|marketing|     PT|   2|false|           0|           0|   false|   false|\n| 24290642|   apple appstore|   2018-03-01|marketing|     US|   1| true|           0|           0|   false|   false|\n| 24290804|      google play|   2018-03-01|marketing|     FR|   1|false|           0|           0|   false|   false|\n| 24291038|      google play|   2018-03-01|marketing|     US|   1| true|           0|           0|   false|   false|\n| 24291371|   apple appstore|   2018-03-01|    viral|     US|   1| true|           0|           0|   false|   false|\n| 24291489|      google play|   2018-03-01|marketing|     EC|   4|false|           0|           0|   false|   false|\n| 24291533|   apple appstore|   2018-03-01|marketing|     US|   1| true|           0|           0|   false|   false|\n| 24291984|   apple appstore|   2018-03-01|marketing|     FR|   1|false|           0|           0|   false|   false|\n| 24292262|      google play|   2018-03-01|    viral|     US|   1| true|           0|           0|   false|   false|\n+---------+-----------------+-------------+---------+-------+----+-----+------------+------------+--------+--------+\nonly showing top 10 rows\n\n"}]}},{"text":"x.filter($\"player_id\" isin (24301438, 24327827, 24412912)).show(10, true)","user":"vgregor","dateUpdated":"2018-12-13T17:37:10+0100","config":{"colWidth":10,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544717781992_1553499410","id":"20181213-171621_1263441624","dateCreated":"2018-12-13T17:16:21+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:873","dateFinished":"2018-12-13T17:37:21+0100","dateStarted":"2018-12-13T17:37:10+0100","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+---------+-----------------+-------------+---------+-------+----+-----+------------+------------+--------+--------+\n|player_id|register_platform|register_date|   source|country|tier|is_us|dx_pay_count|dy_pay_count|dx_payer|dy_payer|\n+---------+-----------------+-------------+---------+-------+----+-----+------------+------------+--------+--------+\n| 24301438|      google play|   2018-03-01|marketing|     US|   1| true|           1|           0|    true|   false|\n| 24327827|      google play|   2018-03-02|marketing|     IT|   2|false|           0|           2|   false|    true|\n| 24412912|      google play|   2018-03-05|marketing|     US|   1| true|           1|           5|    true|    true|\n+---------+-----------------+-------------+---------+-------+----+-----+------------+------------+--------+--------+\n\n"}]}},{"text":"// Double-checking the payments - OK\n\n// val xxx = sqlContext.read.parquet(\"events/DA/2018-*/payment\")\n//     .filter($\"player_id\" isin (24301438, 24327827, 24412912))\n//     .join(getProfiles(\"DA\")(sqlContext), Seq(\"player_id\"), \"left\")\n//     .withColumn(\"create_time\", makeTimestamp.udf($\"event_data/create_time\"))\n//     .withColumn(\"days_in_game\", getDaysBetween.udf($\"register_time\", $\"create_time\"))\n//     .select($\"player_id\", $\"create_time\", $\"event_data/eur_netto\", $\"days_in_game\")\n// \n// xxx.orderBy($\"player_id\", $\"create_time\")show(50, false)","user":"vgregor","dateUpdated":"2018-12-13T16:41:12+0100","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1544714984275_927097029","id":"20181213-162944_1641778776","dateCreated":"2018-12-13T16:29:44+0100","dateStarted":"2018-12-13T16:40:52+0100","dateFinished":"2018-12-13T16:40:52+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:875"},{"user":"vgregor","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1544715401082_-25711458","id":"20181213-163641_2111618994","dateCreated":"2018-12-13T16:36:41+0100","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:876"}],"name":"/vgregor/GA-972 payer model/dataset_v0","id":"2DZUJWSVM","angularObjects":{"2CWQP86XV:shared_process":[],"2CUVK23ET:shared_process":[],"2CT7YKQWE:shared_process":[],"2CWB61MB6:shared_process":[],"2CV4XJYBM:vgregor:":[],"2CT6NMZMH:shared_process":[],"2CWSFKDCB:shared_process":[],"2CTEKSP32:shared_process":[],"2CV83X352:shared_process":[],"2CWTSWYXU:shared_process":[],"2CVUMHN41:shared_process":[],"2CWZ3Q7YQ:shared_process":[],"2CVFU6JRX:shared_process":[],"2CTGV8686:shared_process":[],"2CUUFFKZP:shared_process":[],"2CTWWDH59:shared_process":[],"2CTSJM5JN:shared_process":[],"2CTPKBVRV:shared_process":[],"2CUZUPS95:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}