{"paragraphs":[{"text":"import org.joda.time.LocalDate\nimport org.apache.spark.sql.DataFrame\nimport com.pixelfederation.dwh.spark.utils._","dateUpdated":"2018-12-19T10:07:49+0100","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"import org.joda.time.LocalDate\nimport org.apache.spark.sql.DataFrame\nimport com.pixelfederation.dwh.spark.utils._\n"}]},"apps":[],"jobName":"paragraph_1545207148254_1094994061","id":"20181212-170149_541435616","dateCreated":"2018-12-19T09:12:28+0100","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:453","user":"vgregor","dateFinished":"2018-12-19T10:07:49+0100","dateStarted":"2018-12-19T10:07:49+0100"},{"text":"val project = \"DA\"\n\nval maxDigX = 3\nval maxDigY = 84\nval regDateFrom = LocalDate.parse(\"2018-05-01\")\nval regDateTo = LocalDate.parse(\"2018-05-31\")\nval eventDateTo = regDateTo.plusDays(maxDigX + 1)\nval payDateTo = regDateTo.plusDays(maxDigY + 1)\n\nval dims = Seq(\"player_id\", \"register_platform\", \"register_date\", \"source\", \"country\", \"tier\", \"is_us\")\nval hiveSchema = \"vgregor\"\nval hiveTable = \"ga_972_payer_dataset_v1\"\n\ndef nullToZero(colName: String)(df: DataFrame): DataFrame =\n    df.withColumn(colName, when(col(colName).isNull, lit(0)).otherwise(col(colName)))\n\n// dx - interval of days [0, maxDigX]\n// dy - interval of days (maxDigX, maxDigY]","dateUpdated":"2018-12-19T10:07:49+0100","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"project: String = DA\nmaxDigX: Int = 3\nmaxDigY: Int = 84\nregDateFrom: org.joda.time.LocalDate = 2018-05-01\nregDateTo: org.joda.time.LocalDate = 2018-05-31\neventDateTo: org.joda.time.LocalDate = 2018-06-04\npayDateTo: org.joda.time.LocalDate = 2018-08-24\ndims: Seq[String] = List(player_id, register_platform, register_date, source, country, tier, is_us)\nhiveSchema: String = vgregor\nhiveTable: String = ga_972_payer_dataset_v1\nnullToZero: (colName: String)(df: org.apache.spark.sql.DataFrame)org.apache.spark.sql.DataFrame\n"}]},"apps":[],"jobName":"paragraph_1545207148311_1171559092","id":"20181212-170248_928910633","dateCreated":"2018-12-19T09:12:28+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:454","user":"vgregor","dateFinished":"2018-12-19T10:07:50+0100","dateStarted":"2018-12-19T10:07:49+0100"},{"text":"val tier = sqlContext.table(\"dwh.country_tiers\")\n    .filter($\"project\" === project)\n    .filter($\"quarter\" === getQuarterFromMonth(payDateTo.getMonthOfYear()))\n    .filter($\"year\" === payDateTo.getYear())\n    .select(\n        $\"country_code\".as(\"country\"),\n        $\"tier\"\n    )\n\nval attr = getLastValidAttribution(project, payDateTo)(sqlContext, sc)\n    .select(\n        $\"player_id\",\n        $\"source\"\n    )\n\nval prof = getProfiles(project)(sqlContext)\n    .join(\n        getUserType(project)(sqlContext)\n            .select($\"player_id\", $\"user_type\")\n            .filter($\"user_type\" !== \"user\"),\n        Seq(\"player_id\"),\n        \"left\"\n    )\n    .filter($\"user_type\".isNull)\n    .drop(\"user_type\")\n    .withColumn(\"register_date\", to_date($\"register_time\"))\n    .filter($\"register_date\" >= regDateFrom.toString)\n    .filter($\"register_date\" <= regDateTo.toString)\n    .withColumn(\"is_us\", $\"country\" === \"US\")\n    .join(attr, Seq(\"player_id\"), \"left\")\n    .join(tier, Seq(\"country\"), \"left\")\n    .withColumn(\"tier\", when($\"tier\".isNull, lit(\"4\")).otherwise($\"tier\"))\n    .select(dims ++ Seq(\"register_time\") map col:_*)\n\nval pay = sqlContext.table(project.toLowerCase ++ \"_bckp.monetization\")\n    .select(\n        $\"player_id\",\n        $\"create_time\",\n        $\"order_item_id\",\n        $\"eur_netto\"\n    )\n    .join(prof, Seq(\"player_id\"), \"left\")\n    .filter($\"register_date\".isNotNull)\n    .withColumn(\"days_in_game\", getDaysBetween.udf($\"register_time\", $\"create_time\"))\n    .filter($\"days_in_game\" <= maxDigY)\n    .select(\n        dims ++ \n        Seq(\n            \"create_time\",\n            \"days_in_game\",\n            \"order_item_id\",\n            \"eur_netto\"\n        ) map col:_*\n    )\n\nval payGrp = pay.groupBy(\"player_id\")\n    .agg(\n        count(when($\"days_in_game\" <= maxDigX, $\"player_id\").otherwise(lit(null))).as(\"dx_pay_count\"),\n        count(when($\"days_in_game\" > maxDigX, $\"player_id\").otherwise(lit(null))).as(\"dy_pay_count\")\n    )\n    .withColumn(\"dx_payer\", $\"dx_pay_count\" > 0)\n    .withColumn(\"dy_payer\", $\"dy_pay_count\" > 0)\n\nval sessionThreshold = 30\nval session = sqlContext.table(s\"$project.sessions_threshold\")\n    .filter($\"partition_date\" >= regDateFrom.toString)                  // POZOR NA FILTER PARTITION_DATE (HLAVNE NA NOVOM CLUSTRI)\n    .filter($\"partition_date\" <= eventDateTo.toString)\n    .filter($\"inactivity_threshold\" === sessionThreshold)\n    .join(prof, Seq(\"player_id\"), \"left\")\n    .filter($\"register_date\".isNotNull)\n    .withColumn(\"days_in_game\", getDaysBetween.udf($\"register_time\", $\"session_start\"))\n    .filter($\"days_in_game\" <= maxDigX)\n    .groupBy(\"player_id\")\n    .agg(\n        countDistinct($\"date\").as(\"dx_active_days\"),\n        count(when($\"days_in_game\" <= 0, $\"player_id\").otherwise(lit(null))).as(\"d0_session_count\"),\n        count($\"player_id\").as(\"dx_session_count\")\n    )\n\nval profJoin = prof.select(dims map col:_*)\n    .join(payGrp, Seq(\"player_id\"), \"left\")\n    .transform(nullToZero(\"dx_pay_count\"))\n    .transform(nullToZero(\"dy_pay_count\"))\n    .withColumn(\"dx_payer\", when($\"dx_payer\".isNull, lit(false)).otherwise($\"dx_payer\"))\n    .withColumn(\"dy_payer\", when($\"dy_payer\".isNull, lit(false)).otherwise($\"dy_payer\"))\n    .join(session, Seq(\"player_id\"), \"left\")\n    .transform(nullToZero(\"d0_session_count\"))\n    .transform(nullToZero(\"dx_session_count\"))\n    .transform(nullToZero(\"dx_active_days\"))","dateUpdated":"2018-12-19T10:07:49+0100","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"tier: org.apache.spark.sql.DataFrame = [country: string, tier: string]\nattr: org.apache.spark.sql.DataFrame = [player_id: string, source: string]\nprof: org.apache.spark.sql.DataFrame = [player_id: string, register_platform: string, register_date: date, source: string, country: string, tier: string, is_us: boolean, register_time: timestamp]\npay: org.apache.spark.sql.DataFrame = [player_id: string, register_platform: string, register_date: date, source: string, country: string, tier: string, is_us: boolean, create_time: timestamp, days_in_game: int, order_item_id: string, eur_netto: double]\npayGrp: org.apache.spark.sql.DataFrame = [player_id: string, dx_pay_count: bigint, dy_pay_count: bigint, dx_payer: boolean, dy_payer: boolean]\nsessionThreshold: Int = 30\nsession: org.apache.spark.sql.DataFrame = [player_id: string, dx_active_days: bigint, d0_session_count: bigint, dx_session_count: bigint]\nprofJoin: org.apache.spark.sql.DataFrame = [player_id: string, register_platform: string, register_date: date, source: string, country: string, tier: string, is_us: boolean, dx_pay_count: bigint, dy_pay_count: bigint, dx_payer: boolean, dy_payer: boolean, dx_active_days: bigint, d0_session_count: bigint, dx_session_count: bigint]\n"}]},"apps":[],"jobName":"paragraph_1545207148329_1150782652","id":"20181212-170252_411766982","dateCreated":"2018-12-19T09:12:28+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:455","user":"vgregor","dateFinished":"2018-12-19T10:07:52+0100","dateStarted":"2018-12-19T10:07:50+0100"},{"text":"profJoin.write\n    .format(\"orc\")\n    .mode(\"overwrite\")\n    .saveAsTable(s\"$hiveSchema.$hiveTable\")","dateUpdated":"2018-12-19T10:07:49+0100","config":{"colWidth":11,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1545207148355_1142318176","id":"20181213-160835_751060643","dateCreated":"2018-12-19T09:12:28+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:456","user":"vgregor","dateFinished":"2018-12-19T10:12:57+0100","dateStarted":"2018-12-19T10:07:51+0100"},{"text":"val x = sqlContext.table(s\"$hiveSchema.$hiveTable\")","dateUpdated":"2018-12-19T10:07:49+0100","config":{"colWidth":10,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"x: org.apache.spark.sql.DataFrame = [player_id: string, register_platform: string, register_date: date, source: string, country: string, tier: string, is_us: boolean, dx_pay_count: bigint, dy_pay_count: bigint, dx_payer: boolean, dy_payer: boolean, dx_active_days: bigint, d0_session_count: bigint, dx_session_count: bigint]\n"}]},"apps":[],"jobName":"paragraph_1545207148371_1148474158","id":"20181213-162025_2135551146","dateCreated":"2018-12-19T09:12:28+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:457","user":"vgregor","dateFinished":"2018-12-19T10:12:57+0100","dateStarted":"2018-12-19T10:07:52+0100"},{"text":"x.count\nx.show(10, true)","dateUpdated":"2018-12-19T10:15:53+0100","config":{"colWidth":10,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"res261: Long = 441474\n+---------+-----------------+-------------+---------+-------+----+-----+------------+------------+--------+--------+--------------+----------------+----------------+\n|player_id|register_platform|register_date|   source|country|tier|is_us|dx_pay_count|dy_pay_count|dx_payer|dy_payer|dx_active_days|d0_session_count|dx_session_count|\n+---------+-----------------+-------------+---------+-------+----+-----+------------+------------+--------+--------+--------------+----------------+----------------+\n| 25753517|      google play|   2018-05-01|    viral|     AT|   1|false|           0|           0|   false|   false|             3|               5|               9|\n| 25753850|      google play|   2018-05-01|    viral|     US|   1| true|           0|           0|   false|   false|             0|               0|               0|\n| 25753968|   apple appstore|   2018-05-01|    viral|     ES|   2|false|           0|           0|   false|   false|             1|               1|               1|\n| 25754084|      google play|   2018-05-01|marketing|     BR|   3|false|           0|           0|   false|   false|             1|               1|               1|\n| 25754246|         facebook|   2018-05-01|    viral|     TR|   3|false|           0|           0|   false|   false|             1|               1|               1|\n| 25754408|   apple appstore|   2018-05-01|marketing|     US|   1| true|           0|           0|   false|   false|             1|               1|               1|\n| 25754697|         facebook|   2018-05-01|marketing|     AU|   1|false|           0|           0|   false|   false|             1|               1|               1|\n| 25754741|      google play|   2018-05-01|    viral|     US|   1| true|           0|           0|   false|   false|             1|               2|               2|\n| 25754859|         facebook|   2018-05-01|    viral|     PH|   3|false|           0|           0|   false|   false|             1|               1|               1|\n| 25754903|           amazon|   2018-05-01|    viral|     CA|   1|false|           0|           0|   false|   false|             1|               1|               1|\n+---------+-----------------+-------------+---------+-------+----+-----+------------+------------+--------+--------+--------------+----------------+----------------+\nonly showing top 10 rows\n\n"}]},"apps":[],"jobName":"paragraph_1545207148395_1126928220","id":"20181213-171609_238294854","dateCreated":"2018-12-19T09:12:28+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:458","user":"vgregor","dateFinished":"2018-12-19T10:15:56+0100","dateStarted":"2018-12-19T10:15:53+0100"},{"text":"x.filter($\"player_id\" isin (25795782, 26085365, 25946144, 25946142)).show(10, true)","dateUpdated":"2018-12-19T10:18:17+0100","config":{"colWidth":10,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+---------+-----------------+-------------+---------+-------+----+-----+------------+------------+--------+--------+--------------+----------------+----------------+\n|player_id|register_platform|register_date|   source|country|tier|is_us|dx_pay_count|dy_pay_count|dx_payer|dy_payer|dx_active_days|d0_session_count|dx_session_count|\n+---------+-----------------+-------------+---------+-------+----+-----+------------+------------+--------+--------+--------------+----------------+----------------+\n| 25795782|      google play|   2018-05-03|    viral|     AT|   1|false|           2|           0|    true|   false|             5|               2|               6|\n| 25946144|   apple appstore|   2018-05-14|marketing|     US|   1| true|           0|           3|   false|    true|             4|               1|               5|\n| 26085365|      google play|   2018-05-24|marketing|     AR|   4|false|           1|           6|    true|    true|             5|               2|              11|\n| 25946142|      google play|   2018-05-14|    viral|     FR|   1|false|           0|           0|   false|   false|             1|               1|               1|\n+---------+-----------------+-------------+---------+-------+----+-----+------------+------------+--------+--------+--------------+----------------+----------------+\n\n"}]},"apps":[],"jobName":"paragraph_1545207148417_1215420467","id":"20181213-171621_1263441624","dateCreated":"2018-12-19T09:12:28+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:459","user":"vgregor","dateFinished":"2018-12-19T10:18:20+0100","dateStarted":"2018-12-19T10:18:18+0100"},{"text":"// Double-checking the payments - OK\n\nval xxx = sqlContext.read.parquet(\"events/DA/2018-*/payment\")\n    .filter($\"player_id\" isin (25795782, 26085365, 25946144, 25946142))\n    .join(getProfiles(\"DA\")(sqlContext), Seq(\"player_id\"), \"left\")\n    .withColumn(\"create_time\", makeTimestamp.udf($\"event_data/create_time\"))\n    .withColumn(\"days_in_game\", getDaysBetween.udf($\"register_time\", $\"create_time\"))\n    .select($\"player_id\", $\"create_time\", $\"event_data/eur_netto\", $\"days_in_game\")\n\nxxx.orderBy($\"player_id\", $\"create_time\")show(50, false)","dateUpdated":"2018-12-19T10:18:52+0100","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala"}},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"xxx: org.apache.spark.sql.DataFrame = [player_id: string, create_time: timestamp, event_data/eur_netto: double, days_in_game: int]\n+---------+---------------------+--------------------+------------+\n|player_id|create_time          |event_data/eur_netto|days_in_game|\n+---------+---------------------+--------------------+------------+\n|25795782 |2018-05-06 12:49:06.0|5.824               |2           |\n|25795782 |2018-05-06 12:51:06.0|2.912               |2           |\n|25946144 |2018-05-30 05:14:39.0|2.4143536944107975  |15          |\n|25946144 |2018-06-06 20:19:16.0|2.9877730192719483  |22          |\n|25946144 |2018-06-23 00:47:28.0|12.01147664835165   |39          |\n|26085365 |2018-05-27 19:42:19.0|4.186423982869379   |3           |\n|26085365 |2018-06-25 05:02:13.0|3.50103021978022    |32          |\n|26085365 |2018-06-29 05:01:03.0|3.485568505568506   |36          |\n|26085365 |2018-07-10 03:28:08.0|6.987379760793961   |47          |\n|26085365 |2018-07-16 00:48:33.0|7.013043030146869   |52          |\n|26085365 |2018-07-20 05:40:18.0|3.505857783914394   |57          |\n|26085365 |2018-08-01 03:45:32.0|6.979202453987731   |69          |\n+---------+---------------------+--------------------+------------+\n\n"}]},"apps":[],"jobName":"paragraph_1545207148440_1218883207","id":"20181213-162944_1641778776","dateCreated":"2018-12-19T09:12:28+0100","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:460","user":"vgregor","dateFinished":"2018-12-19T10:19:44+0100","dateStarted":"2018-12-19T10:18:52+0100"},{"dateUpdated":"2018-12-19T09:12:28+0100","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala"},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1545207148465_1209264484","id":"20181213-163641_2111618994","dateCreated":"2018-12-19T09:12:28+0100","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:461"}],"name":"/vgregor/GA-972 payer model/dataset_v1","id":"2DY3NVTV1","angularObjects":{"2CWQP86XV:shared_process":[],"2CUVK23ET:shared_process":[],"2CT7YKQWE:shared_process":[],"2CWB61MB6:shared_process":[],"2CV4XJYBM:vgregor:":[],"2CT6NMZMH:shared_process":[],"2CWSFKDCB:shared_process":[],"2CTEKSP32:shared_process":[],"2CV83X352:shared_process":[],"2CWTSWYXU:shared_process":[],"2CVUMHN41:shared_process":[],"2CWZ3Q7YQ:shared_process":[],"2CVFU6JRX:shared_process":[],"2CTGV8686:shared_process":[],"2CUUFFKZP:shared_process":[],"2CTWWDH59:shared_process":[],"2CTSJM5JN:shared_process":[],"2CTPKBVRV:shared_process":[],"2CUZUPS95:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}